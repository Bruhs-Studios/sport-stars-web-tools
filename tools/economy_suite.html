<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportStars Pro Balancing Suite</title>
    <!-- Favicon: Upload favicon.ico to your root directory -->
    <link rel="icon" href="../favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono&display=swap');
        :root { --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --danger: #ef4444; --success: #22c55e; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #f1f5f9; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .nav-btn.active { background-color: var(--accent); color: white; }
        .section-content { display: none; }
        .section-content.active { display: block; }
        input[type="number"], input[type="text"] {
            background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 0.25rem 0.5rem; width: 100%; color: #fff; font-size: 0.75rem;
        }
        input[type="checkbox"] {
            accent-color: #3b82f6;
            width: 14px; height: 14px; cursor: pointer;
        }
        .card { background: var(--card); border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .warning-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .help-cursor { cursor: help; border-bottom: 1px dotted #64748b; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col flex-shrink-0 z-20">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-blue-500 italic">SportStars</h1>
            <p class="text-xs text-slate-500">Pro Balancing v3.4.1</p>
        </div>
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <button onclick="showSection('chapters')" class="nav-btn active w-full text-left p-3 rounded-lg text-sm flex items-center gap-3 transition-colors"><i class="fa fa-map w-5"></i> Chapters & Rewards</button>
            <button onclick="showSection('trainings')" class="nav-btn w-full text-left p-3 rounded-lg text-sm flex items-center gap-3 transition-colors"><i class="fa fa-dumbbell w-5"></i> Trainings & Slots</button>
            <button onclick="showSection('scout')" class="nav-btn w-full text-left p-3 rounded-lg text-sm flex items-center gap-3 transition-colors"><i class="fa fa-binoculars w-5"></i> Scout (Athletes)</button>
            <button onclick="showSection('managers')" class="nav-btn w-full text-left p-3 rounded-lg text-sm flex items-center gap-3 transition-colors"><i class="fa fa-user-tie w-5"></i> Managers</button>
            <button onclick="showSection('shop')" class="nav-btn w-full text-left p-3 rounded-lg text-sm flex items-center gap-3 transition-colors"><i class="fa fa-store w-5"></i> Shop & Gacha</button>
        </nav>
        <div class="p-4 bg-slate-950 border-t border-slate-800 space-y-2">
            <button onclick="openImport()" class="w-full bg-slate-800 hover:bg-slate-700 p-3 rounded-lg font-bold transition-all text-xs flex items-center justify-center gap-2"><i class="fa fa-file-import"></i> Import</button>
            <button onclick="exportYAML()" class="w-full bg-green-600 hover:bg-green-700 p-3 rounded-lg font-bold transition-all text-xs flex items-center justify-center gap-2"><i class="fa fa-file-export"></i> Export</button>
            <button onclick="resetConfig()" class="w-full bg-red-900/50 hover:bg-red-900 border border-red-800 p-3 rounded-lg font-bold transition-all text-xs text-red-300 flex items-center justify-center gap-2 mt-4"><i class="fa fa-trash-alt"></i> Reset Defaults</button>
        </div>
    </aside>

    <!-- Main Content Split -->
    <main class="flex flex-grow h-full overflow-hidden">
        
        <!-- LEFT PANEL: CONFIGURATION -->
        <div id="config-panel" class="w-1/2 h-full overflow-y-auto p-8 bg-slate-950 scroll-smooth border-r border-slate-800">
            
            <!-- SECTION: CHAPTERS & REWARDS -->
            <section id="chapters" class="section-content active space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Chapters & Progression</h2>
                </div>
                
                <!-- Reward Config -->
                <div class="card space-y-4">
                    <h3 class="font-bold border-b border-slate-700 pb-2 help-cursor" title="Define how much currency players earn for completing stages.">Stage Reward Config</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-green-400 font-bold help-cursor" title="The cash reward for Stage 1.1">Base Cash</label><input type="number" id="stage_cash_base" value="2000" onchange="updateCharts();saveConfig()"></div>
                        <div><label class="text-xs text-green-400 font-bold help-cursor" title="Multiplier applied every stage: Reward = Base * (Mult ^ StageIndex)">Cash Multiplier</label><input type="number" id="stage_cash_mult" value="2.6" step="0.1" onchange="updateCharts();saveConfig()"></div>
                        <div><label class="text-xs text-yellow-400 font-bold help-cursor" title="The fame reward for Stage 1.1">Base Fame</label><input type="number" id="stage_fame_base" value="100" onchange="updateCharts();saveConfig()"></div>
                        <div><label class="text-xs text-yellow-400 font-bold help-cursor" title="Linear increase per stage: Reward = Base + (Growth * StageIndex)">Fame Growth</label><input type="number" id="stage_fame_growth" value="45" onchange="updateCharts();saveConfig()"></div>
                    </div>
                </div>

                <!-- Chapter Inputs -->
                <h3 class="font-bold text-xl mt-4">Chapter Definitions</h3>
                <div class="space-y-4" id="chapter-inputs">
                    <!-- Dynamically populated -->
                </div>
            </section>

            <!-- SECTION: TRAININGS -->
            <section id="trainings" class="section-content space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Training Slots & Math</h2>
                </div>

                <!-- Global Math -->
                <div class="card space-y-4">
                    <h3 class="font-bold border-b border-slate-700 pb-2 help-cursor" title="Global formulas affecting all trainings.">Global Math Configs</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-xs text-slate-500 help-cursor" title="Cost increases by this factor every level (1.15 = +15%).">Cost Expo (Rec: 1.15)</label><input type="number" id="cost_expo" value="1.15" step="0.01" onchange="updateCharts();saveConfig()"></div>
                        <div><label class="text-xs text-slate-500 help-cursor" title="Income increases by this factor every level (1.09 = +9%). Must be < Cost Expo.">Income Expo (Rec: 1.09)</label><input type="number" id="income_expo" value="1.09" step="0.01" onchange="updateCharts();saveConfig()"></div>
                        <div><label class="text-xs text-slate-500 help-cursor" title="Duration gets multiplied by this every level (0.99 = 1% faster).">Dur Decay (Rec: 0.9973)</label><input type="number" id="dur_decay" value="0.9973" step="0.0001" onchange="updateCharts();saveConfig()"></div>
                    </div>
                </div>

                <!-- Slots Editor -->
                <div id="slots-container" class="space-y-4">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- SECTION: SCOUT -->
            <section id="scout" class="section-content space-y-6">
                <h2 class="text-2xl font-bold mb-6">Scout & Athlete Recruitment</h2>
                <div class="card space-y-4">
                    <h3 class="font-bold border-b border-slate-700 pb-2">Pull Costs (Fame)</h3>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label class="text-[10px] uppercase text-slate-500 help-cursor" title="Fame cost for a single pull">x1 Pull</label>
                            <input type="number" id="scout_x1" value="100" onchange="updateCharts();saveConfig()">
                        </div>
                        <div class="input-group">
                            <label class="text-[10px] uppercase text-slate-500 help-cursor" title="Fame cost for 10 pulls">x10 Pull</label>
                            <input type="number" id="scout_x10" value="900" onchange="updateCharts();saveConfig()">
                        </div>
                        <div class="input-group">
                            <label class="text-[10px] uppercase text-slate-500 help-cursor" title="Fame cost for 40 pulls">x40 Pull</label>
                            <input type="number" id="scout_x40" value="3200" onchange="updateCharts();saveConfig()">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION: MANAGERS -->
            <section id="managers" class="section-content space-y-6">
                <h2 class="text-2xl font-bold mb-6">Manager Leveling</h2>
                <div class="grid grid-cols-1 gap-6">
                    <div class="card p-4 bg-slate-900/50 rounded-xl border border-blue-500/20">
                        <h4 class="font-bold text-blue-400 mb-2">Rare Cost Formula</h4>
                        <p class="text-xs text-slate-500 mb-2 help-cursor" title="Linear Scaling: Cost = Current Level * Multiplier">Cost: Level * Mult</p>
                        <input type="number" id="rare_mult" value="5" onchange="updateCharts();saveConfig()">
                    </div>
                    <div class="card p-4 bg-slate-900/50 rounded-xl border border-purple-500/20">
                        <h4 class="font-bold text-purple-400 mb-2">Epic Cost Formula</h4>
                        <p class="text-xs text-slate-500 mb-2 help-cursor" title="Linear Scaling: Cost = Current Level * Multiplier">Cost: Level * Mult</p>
                        <input type="number" id="epic_mult" value="3" onchange="updateCharts();saveConfig()">
                    </div>
                    <div class="card p-4 bg-slate-900/50 rounded-xl border border-orange-500/20">
                        <h4 class="font-bold text-orange-400 mb-2">Legend (Fixed)</h4>
                        <p class="text-xs text-slate-500 mb-2 help-cursor" title="Fibonacci Sequence: 1, 2, 3, 5, 8, 13...">Fibonacci(Level)</p>
                        <div class="text-xs mono text-orange-300 mt-2">1, 2, 3, 5, 8, 13...</div>
                    </div>
                </div>
            </section>

            <!-- SECTION: SHOP -->
            <section id="shop" class="section-content space-y-6">
                <h2 class="text-2xl font-bold mb-6">Shop & Gacha Economy</h2>
                
                <div class="card space-y-4">
                    <h3 class="font-bold border-b border-slate-700 pb-2">Diamond Packs</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-800 text-slate-400">
                                <tr>
                                    <th class="p-2">Tier</th>
                                    <th class="p-2">Price ($)</th>
                                    <th class="p-2">Diamonds</th>
                                    <th class="p-2 text-right">Bonus %</th>
                                </tr>
                            </thead>
                            <tbody id="diamond_packs_table" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-slate-800 rounded text-center">
                        <span class="text-xs text-slate-400 help-cursor" title="Calculated from Tier 1: Price / Amount">Base Valuation (Tier 1): 1 Diamond = </span>
                        <span id="diamond_value_base" class="text-green-400 font-bold font-mono">...</span>
                    </div>
                </div>

                <div class="card space-y-4">
                    <h3 class="font-bold border-b border-slate-700 pb-2">Chest Balancing</h3>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="text-center p-3 border border-blue-900/50 rounded bg-slate-800/20 grid grid-cols-3 items-center">
                            <h4 class="text-sm font-bold text-blue-400 text-left">Rare Chest</h4>
                            <div><label class="text-[10px] text-slate-500">Cost</label><input type="number" id="chest_rare_cost" value="150"></div>
                            <div><label class="text-[10px] text-slate-500">Cards</label><input type="number" id="chest_rare_cards" value="15"></div>
                        </div>
                        <div class="text-center p-3 border border-purple-900/50 rounded bg-slate-800/20 grid grid-cols-3 items-center">
                            <h4 class="text-sm font-bold text-purple-400 text-left">Epic Chest</h4>
                            <div><label class="text-[10px] text-slate-500">Cost</label><input type="number" id="chest_epic_cost" value="450"></div>
                            <div><label class="text-[10px] text-slate-500">Cards</label><input type="number" id="chest_epic_cards" value="6"></div>
                        </div>
                        <div class="text-center p-3 border border-orange-900/50 rounded bg-slate-800/20 grid grid-cols-3 items-center">
                            <h4 class="text-sm font-bold text-orange-400 text-left">Legend Chest</h4>
                            <div><label class="text-[10px] text-slate-500">Cost</label><input type="number" id="chest_legend_cost" value="1200"></div>
                            <div><label class="text-[10px] text-slate-500">Cards</label><input type="number" id="chest_legend_cards" value="2.5" step="0.1"></div>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- RIGHT PANEL: CHARTS & ANALYSIS (Always Visible) -->
        <div id="charts-panel" class="w-1/2 h-full overflow-y-auto p-8 bg-slate-900">
            <h2 class="text-xl font-bold mb-6 text-white border-b border-slate-700 pb-2"><i class="fa fa-chart-pie mr-2 text-blue-500"></i>Analysis Dashboard</h2>
            
            <div class="space-y-8">
                
                <!-- Health Status -->
                <div class="flex items-center justify-between bg-slate-800 p-4 rounded-lg">
                    <span class="text-sm font-bold text-slate-400 help-cursor" title="Checks if Income Growth < Cost Growth. If Income grows faster, the game breaks.">Economy State</span>
                    <div id="health-status" class="px-4 py-2 rounded-full text-xs font-bold bg-green-900 text-green-300 border border-green-500">
                        STATUS: HEALTHY
                    </div>
                </div>

                <!-- 1. Progression Sim Visualization -->
                <div class="card border border-blue-500/30 bg-blue-900/10 shadow-lg shadow-black/20">
                    <h3 class="font-bold mb-4 flex justify-between items-center text-white help-cursor" title="A snapshot of the progression math from the Chapters section.">
                        <span>Progression Analysis (Slots Inclusive)</span>
                        <span class="text-[10px] text-blue-300 bg-blue-900/50 px-2 py-1 rounded">LIVE TABLE</span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs text-slate-300">
                            <thead class="bg-slate-800 text-slate-400 uppercase">
                                <tr>
                                    <th class="p-2 help-cursor" title="Chapter">Ch</th>
                                    <th class="p-2 help-cursor" title="Total cash needed to unlock slots + upgrade levels to cap">Total Cost</th>
                                    <th class="p-2 help-cursor" title="Sum of all cash rewards from stages in this chapter">Total Stage Cash</th>
                                    <th class="p-2 help-cursor" title="How many levels 1 stage win buys">Buying Power</th>
                                    <th class="p-2 help-cursor" title="Surplus = Rewards > Cost. Deficit = Idle needed.">Status</th>
                                </tr>
                            </thead>
                            <tbody id="sim-table" class="divide-y divide-slate-700/50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. Time To Upgrade (Multi-Line) -->
                <div class="card border-l-4 border-yellow-500 shadow-lg shadow-black/20">
                    <div class="mb-4">
                        <h3 class="font-bold text-lg text-white help-cursor" title="The single most important metric. Shows how many seconds of idle income it takes to afford the NEXT level upgrade.">Time To Next Upgrade (The Wall)</h3>
                        <p class="text-xs text-slate-400">Lines show seconds needed to afford the next level for each training. Includes chapter durations and slot income.</p>
                    </div>
                    <div class="h-[350px]">
                        <canvas id="timeToUpgradeChart"></canvas>
                    </div>
                </div>

                <!-- 3. Duration Decay -->
                <div class="card shadow-lg shadow-black/20">
                    <h3 class="font-bold mb-4 text-white help-cursor" title="Shows how the cycle duration reduces as training level increases.">Duration Decay (% of Base)</h3>
                    <div class="h-[200px]">
                        <canvas id="durationChart"></canvas>
                    </div>
                </div>

                <!-- 4. Cost vs Income (Cardio Reference) -->
                <div class="card shadow-lg shadow-black/20">
                    <h3 class="font-bold mb-4 text-white help-cursor" title="Logarithmic view of Cost vs Income per Second for the base training (Cardio).">Cost vs Income (Cardio Baseline)</h3>
                    <div class="h-[250px]">
                        <canvas id="trainingChart"></canvas>
                    </div>
                </div>

                <!-- 5. Fame Accumulation -->
                <div class="card shadow-lg shadow-black/20">
                    <h3 class="font-bold mb-4 text-white help-cursor" title="Total Fame earned by completing stages sequentially.">Cumulative Fame</h3>
                    <div class="h-[200px]">
                        <canvas id="fameChart"></canvas>
                    </div>
                </div>

                <!-- 6. Scout Pulls -->
                <div class="card shadow-lg shadow-black/20">
                    <h3 class="font-bold mb-4 text-white help-cursor" title="How many athletes a player can recruit based on Cumulative Fame.">Cumulative Athlete Pulls</h3>
                    <div class="h-[200px]">
                        <canvas id="scoutChart"></canvas>
                    </div>
                </div>

                <!-- 7. Shop Analysis -->
                <div class="card shadow-lg shadow-black/20">
                    <h3 class="font-bold mb-4 text-white help-cursor" title="Evaluation of chest value in USD based on Diamond Pack pricing.">Shop Value Analysis</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-800 text-slate-400">
                                <tr>
                                    <th class="p-2 help-cursor" title="Chest Type">Chest</th>
                                    <th class="p-2 help-cursor" title="Calculated USD cost based on Tier 1 Diamond Pack">$$ Cost</th>
                                    <th class="p-2 help-cursor" title="Price per single card">$/Card</th>
                                    <th class="p-2 help-cursor" title="Cards per $1 USD">Cards/$</th>
                                </tr>
                            </thead>
                            <tbody id="shop_analysis_table" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- MODALS -->
    <div id="exportModal" class="fixed inset-0 bg-black/90 hidden z-50 items-center justify-center p-4 md:p-8">
        <div class="bg-slate-900 w-full max-w-4xl rounded-2xl border border-slate-700 flex flex-col h-[85vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-green-400 flex items-center gap-2">Export YAML</h3>
                <button onclick="closeExport()" class="text-slate-400 hover:text-white p-2"><i class="fa fa-times text-xl"></i></button>
            </div>
            <textarea id="yamlOutput" class="flex-grow p-6 mono text-xs bg-slate-950 text-green-400 outline-none resize-none" readonly></textarea>
            <div class="p-4 border-t border-slate-700 flex justify-between items-center">
                <p class="text-xs text-slate-500">Copy this into your game's config loader.</p>
                <button onclick="copyToClipboard()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-bold">Copy</button>
            </div>
        </div>
    </div>

    <div id="importModal" class="fixed inset-0 bg-black/90 hidden z-50 items-center justify-center p-4 md:p-8">
        <div class="bg-slate-900 w-full max-w-2xl rounded-2xl border border-slate-700 flex flex-col h-[60vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-bold text-blue-400 flex items-center gap-2">Import YAML</h3>
                <button onclick="closeImport()" class="text-slate-400 hover:text-white p-2"><i class="fa fa-times text-xl"></i></button>
            </div>
            <textarea id="yamlInput" class="flex-grow p-6 mono text-xs bg-slate-950 text-slate-300 outline-none resize-none" placeholder="Paste YAML here..."></textarea>
            <div class="p-4 border-t border-slate-700 flex justify-end gap-3">
                <button onclick="closeImport()" class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button onclick="parseAndImport()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-bold">Import</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'sportstars_config_v3_4_1';

        // --- DATA MODEL ---
        const state = {
            chapters: [
                { id: 1, stages: 5, cap: 20, dur: 6, pulls: "6-10" },
                { id: 2, stages: 8, cap: 60, dur: 30, pulls: "30-50" },
                { id: 3, stages: 10, cap: 120, dur: 120, pulls: "60-80" },
                { id: 4, stages: 10, cap: 180, dur: 120, pulls: "100-120" },
                { id: 5, stages: 10, cap: 240, dur: 120, pulls: "150-180" },
                { id: 6, stages: 10, cap: 300, dur: 120, pulls: "200+" }
            ],
            packs: [
                { price: 0.99, amount: 100 },
                { price: 4.99, amount: 550 },
                { price: 9.99, amount: 1200 },
                { price: 19.99, amount: 2500 },
                { price: 49.99, amount: 6500 },
                { price: 99.99, amount: 14000 }
            ],
            // Updated Defaults: Higher base upgrades to offset 4x income slots
            trainings: [
                { id: 'cardio', name: 'Cardio', baseUpgrade: 30, color: '#ef4444', slots: [
                    { unlock: 0, income: 40, checked: true }, { unlock: 750, income: 150, checked: true }, { unlock: 3000, income: 600, checked: true }, { unlock: 12000, income: 2400, checked: true }
                ]},
                { id: 'dodging', name: 'Dodging', baseUpgrade: 300, color: '#f97316', slots: [
                    { unlock: 100, income: 200, checked: true }, { unlock: 4000, income: 800, checked: true }, { unlock: 16000, income: 3200, checked: true }, { unlock: 64000, income: 12800, checked: true }
                ]},
                { id: 'curl', name: 'Curl', baseUpgrade: 3000, color: '#eab308', slots: [
                    { unlock: 25000, income: 2500, checked: true }, { unlock: 150000, income: 10000, checked: true }, { unlock: 1000000, income: 40000, checked: true }, { unlock: 5000000, income: 160000, checked: true }
                ]},
                { id: 'throwing', name: 'Throwing', baseUpgrade: 30000, color: '#22c55e', slots: [
                    { unlock: 5000000, income: 18000, checked: true }, { unlock: 50000000, income: 72000, checked: true }, { unlock: 500000000, income: 280000, checked: true }, { unlock: 5000000000, income: 1100000, checked: true }
                ]},
                { id: 'chess', name: 'Chess', baseUpgrade: 300000, color: '#06b6d4', slots: [
                    { unlock: 200000000, income: 140000, checked: true }, { unlock: 2000000000, income: 560000, checked: true }, { unlock: 20000000000, income: 2200000, checked: true }, { unlock: 200000000000, income: 8800000, checked: true }
                ]},
                { id: 'pingpong', name: 'Pingpong', baseUpgrade: 3000000, color: '#3b82f6', slots: [
                    { unlock: 1000000000, income: 1200000, checked: true }, { unlock: 10000000000, income: 4800000, checked: true }, { unlock: 100000000000, income: 19000000, checked: true }, { unlock: 1000000000000, income: 76000000, checked: true }
                ]},
                { id: 'slamming', name: 'Slamming', baseUpgrade: 15000000, color: '#a855f7', slots: [
                    { unlock: 50000000000, income: 8000000, checked: true }, { unlock: 500000000000, income: 32000000, checked: true }, { unlock: 5000000000000, income: 128000000, checked: true }, { unlock: 50000000000000, income: 512000000, checked: true }
                ]}
            ],
            charts: {}
        };

        // --- INIT & NAVIGATION ---
        function init() {
            loadConfig();
            renderChapterInputs();
            renderTrainingInputs();
            renderPacksTable();
            updateCharts();
            updateShop();
            document.querySelectorAll('input').forEach(i => i.addEventListener('change', saveConfig));
        }

        function showSection(id) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(id)) {
                    btn.classList.add('active');
                }
            });
            updateCharts();
        }

        function syncInputs(targetId, val) {
            const el = document.getElementById(targetId);
            if(el) {
                el.value = val;
                updateCharts();
            }
        }

        // --- RENDERING UI ---
        function renderChapterInputs() {
            const container = document.getElementById('chapter-inputs');
            container.innerHTML = ''; 
            state.chapters.forEach((ch, i) => {
                const div = document.createElement('div');
                div.className = "card space-y-3 border-l-4 border-blue-500 hover:border-blue-400 transition-colors";
                div.innerHTML = `
                    <h4 class="font-bold flex justify-between">Chapter ${ch.id} <span class="text-xs text-slate-500 font-normal">Cap ${ch.cap}</span></h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label class="text-[10px] uppercase font-bold text-slate-500 help-cursor" title="Number of stages in this chapter">Stages</label>
                            <input type="number" onchange="state.chapters[${i}].stages=parseInt(this.value);updateCharts();saveConfig()" value="${ch.stages}">
                        </div>
                        <div class="input-group">
                            <label class="text-[10px] uppercase font-bold text-slate-500 help-cursor" title="Max level for trainings in this chapter">Lvl Cap</label>
                            <input type="number" onchange="state.chapters[${i}].cap=parseInt(this.value);updateCharts();saveConfig()" value="${ch.cap}">
                        </div>
                        <div class="input-group col-span-2">
                            <label class="text-[10px] uppercase font-bold text-slate-500 help-cursor" title="Base training cycle duration in seconds for this chapter">Base Dur (s)</label>
                            <input type="number" onchange="state.chapters[${i}].dur=parseInt(this.value);updateCharts();saveConfig()" value="${ch.dur}">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderTrainingInputs() {
            const container = document.getElementById('slots-container');
            container.innerHTML = '';
            
            state.trainings.forEach((t, tIdx) => {
                let slotsHtml = '';
                t.slots.forEach((s, sIdx) => {
                    slotsHtml += `
                        <div class="bg-slate-900/50 p-2 rounded border border-slate-800 text-center relative" title="Configure Slot ${sIdx+1}">
                            <div class="absolute top-1 right-1">
                                <input type="checkbox" ${s.checked ? 'checked' : ''} onchange="toggleSlot(${tIdx}, ${sIdx})" title="Include in chart calculations?">
                            </div>
                            <div class="text-[10px] font-bold text-slate-400 mb-1">Slot ${sIdx + 1}</div>
                            <label class="text-[8px] text-slate-500 block help-cursor" title="Cost to unlock this slot">Unlock Cost</label>
                            <input type="number" class="mb-1 text-center" placeholder="Unlock" value="${s.unlock}" onchange="updateSlot(${tIdx}, ${sIdx}, 'unlock', this.value)">
                            <label class="text-[8px] text-green-500 block help-cursor" title="Base income per cycle at Level 1">Cash/Cycle</label>
                            <input type="number" class="text-center text-green-400 font-bold" placeholder="Base" value="${s.income}" onchange="updateSlot(${tIdx}, ${sIdx}, 'income', this.value)">
                        </div>
                    `;
                });

                const html = `
                    <div class="card border border-slate-700">
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                            <h4 class="font-bold" style="color:${t.color}">${t.name}</h4>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] text-slate-500 help-cursor" title="Base cost to upgrade from Level 0 to 1">Base Upgrade Cost ($):</label>
                                <input type="number" class="w-24 text-xs font-mono text-red-300" value="${t.baseUpgrade}" onchange="updateTrainingBase(${tIdx}, this.value)">
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${slotsHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function updateSlot(tIdx, sIdx, field, val) {
            state.trainings[tIdx].slots[sIdx][field] = parseFloat(val);
            updateCharts();
            saveConfig();
        }
        
        function toggleSlot(tIdx, sIdx) {
            state.trainings[tIdx].slots[sIdx].checked = !state.trainings[tIdx].slots[sIdx].checked;
            updateCharts();
            saveConfig();
        }

        function updateTrainingBase(tIdx, val) {
            state.trainings[tIdx].baseUpgrade = parseFloat(val);
            updateCharts();
            saveConfig();
        }

        // --- SIMULATION LOGIC ---
        function runSimulation(costExpo, stageCashBase, stageCashMult) {
            const tbody = document.getElementById('sim-table');
            tbody.innerHTML = '';
            let globalStageIdx = 0;
            let currentLevel = 0; 

            state.chapters.forEach((ch, chIdx) => {
                const maxSlotsAllowed = ch.id === 1 ? 2 : (ch.id === 2 ? 3 : 4);
                let totalChapterCost = 0;
                let activeTrainings = [];
                // Simple assumption: Trainings unlock based on array index ~ chapter
                if (ch.id === 1) activeTrainings = [0, 1];
                else if (ch.id === 2) activeTrainings = [0, 1, 2];
                else if (ch.id === 3) activeTrainings = [0, 1, 2, 3];
                else if (ch.id === 4) activeTrainings = [0, 1, 2, 3, 4];
                else activeTrainings = [0, 1, 2, 3, 4, 5, 6];

                activeTrainings.forEach(tIdx => {
                    const t = state.trainings[tIdx];
                    for (let l = currentLevel; l < ch.cap; l++) {
                        totalChapterCost += t.baseUpgrade * Math.pow(costExpo, l);
                    }
                    // FIXED LOGIC: Only count unlock cost if it becomes available IN THIS CHAPTER
                    for(let s=0; s < maxSlotsAllowed; s++) {
                        let shouldCountCost = false;
                        if (ch.id === 1 && s < 2) shouldCountCost = true; // Ch1 unlocks 0 & 1
                        if (ch.id === 2 && s === 2) shouldCountCost = true; // Ch2 unlocks 2
                        if (ch.id === 3 && s === 3) shouldCountCost = true; // Ch3 unlocks 3
                        // Ch4+ does not unlock any new slots, so no cost added.
                        
                        if (shouldCountCost) totalChapterCost += t.slots[s].unlock;
                    }
                });

                // Buying Power: Benchmark against Training 0 (Cardio) Base Cost at current level
                const t0 = state.trainings[0];
                const costOfOneLevel = t0.baseUpgrade * Math.pow(costExpo, currentLevel);
                const firstStageReward = stageCashBase * Math.pow(stageCashMult, globalStageIdx);
                const levelsBuyable = firstStageReward / costOfOneLevel;

                let totalChapterRewards = 0;
                for (let s = 0; s < ch.stages; s++) {
                    totalChapterRewards += stageCashBase * Math.pow(stageCashMult, globalStageIdx);
                    globalStageIdx++;
                }

                const isSurplus = totalChapterRewards >= totalChapterCost;
                const statusHtml = isSurplus 
                    ? `<span class="text-green-400 font-bold" title="Rewards exceed costs. Easy progress."><i class="fa fa-check-circle"></i> Surplus</span>`
                    : `<span class="text-red-400 font-bold" title="Costs exceed rewards. Idle grinding required."><i class="fa fa-clock"></i> Deficit</span>`;
                
                let powerColor = levelsBuyable > 5 ? "text-green-400 font-bold" : (levelsBuyable > 1 ? "text-yellow-400" : "text-red-400");

                const row = `
                    <tr class="hover:bg-slate-800/50">
                        <td class="p-2 border-b border-slate-700 font-bold" title="Chapter Index">Ch ${ch.id}</td>
                        <td class="p-2 border-b border-slate-700 text-slate-300 font-mono" title="Upgrade Costs + Slot Unlocks">${totalChapterCost.toExponential(2)}</td>
                        <td class="p-2 border-b border-slate-700 text-green-300 font-mono" title="Sum of all stage rewards in chapter">${totalChapterRewards.toExponential(2)}</td>
                        <td class="p-2 border-b border-slate-700 font-mono ${powerColor}" title="Levels buyable with 1 stage reward">${levelsBuyable.toFixed(2)}</td>
                        <td class="p-2 border-b border-slate-700 text-xs">${statusHtml}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
                currentLevel = ch.cap;
            });
        }

        // --- CHARTS & LOGIC ---
        function updateCharts() {
            const costExpo = parseFloat(document.getElementById('cost_expo').value) || 1.15;
            const incomeExpo = parseFloat(document.getElementById('income_expo').value) || 1.09;
            const durDecay = parseFloat(document.getElementById('dur_decay').value) || 0.9973;
            const scoutX1 = parseFloat(document.getElementById('scout_x1').value) || 100;
            const stageCashBase = parseFloat(document.getElementById('stage_cash_base').value);
            const stageCashMult = parseFloat(document.getElementById('stage_cash_mult').value);
            const stageFameBase = parseFloat(document.getElementById('stage_fame_base').value);
            const stageFameGrowth = parseFloat(document.getElementById('stage_fame_growth').value);

            runSimulation(costExpo, stageCashBase, stageCashMult);

            // 1. Time To Upgrade (Multi-Line for 7 Trainings)
            const trLabels = Array.from({length: 61}, (_, i) => i * 5); 
            const ttuDatasets = [];
            
            // Map training index to Chapter index for Base Duration
            // T0, T1 -> Ch0 (id1). T2 -> Ch1. T3 -> Ch2. T4 -> Ch3. T5 -> Ch4. T6 -> Ch5.
            const tToChMap = [0, 0, 1, 2, 3, 4, 5]; 

            state.trainings.forEach((t, tIdx) => {
                const chIdx = tToChMap[tIdx];
                const baseDur = state.chapters[chIdx].dur; // Use specific chapter duration!
                
                // Calculate Income sum of checked slots
                const activeSlotIncome = t.slots.reduce((sum, s) => s.checked ? sum + s.income : sum, 0);
                
                if(activeSlotIncome > 0) {
                    const data = trLabels.map(l => {
                        const cost = t.baseUpgrade * Math.pow(costExpo, Math.max(0, l-1));
                        const inc = activeSlotIncome * Math.pow(incomeExpo, Math.max(0, l-1));
                        const dur = baseDur * Math.pow(durDecay, Math.max(0, l-1));
                        const incPerSec = inc / Math.max(0.1, dur);
                        return cost / incPerSec;
                    });
                    ttuDatasets.push({ label: t.name, data: data, color: t.color });
                }
            });
            renderLineChart('timeToUpgradeChart', trLabels, ttuDatasets, true);

            // 2. Cardio Specific Cost/Income (Reference)
            const t0 = state.trainings[0];
            const t0Cost = trLabels.map(l => t0.baseUpgrade * Math.pow(costExpo, Math.max(0, l-1)));
            const t0Income = t0.slots.reduce((sum, s) => s.checked ? sum + s.income : sum, 0);
            const t0BaseDur = state.chapters[0].dur;
            const t0IncPerSec = trLabels.map(l => {
                const inc = t0Income * Math.pow(incomeExpo, Math.max(0, l-1));
                const dur = t0BaseDur * Math.pow(durDecay, Math.max(0, l-1));
                return inc / Math.max(0.1, dur);
            });
            renderLineChart('trainingChart', trLabels, [
                { label: 'Cardio Upgrade Cost', data: t0Cost, color: '#ef4444' },
                { label: 'Cardio Income/Sec', data: t0IncPerSec, color: '#22c55e' }
            ], true);

            // 3. Duration Decay
            const durValues = trLabels.map(l => 100 * Math.pow(durDecay, Math.max(0, l-1)));
            renderLineChart('durationChart', trLabels, [
                { label: '% of Base Duration', data: durValues, color: '#3b82f6' }
            ], false);

            // 4. Fame & Scout
            let globalIdx = 0;
            let totalFame = 0;
            const fameLabels = [];
            const fameValues = [];
            const scoutValues = [];
            state.chapters.forEach(ch => {
                for(let s=0; s<ch.stages; s++) {
                    totalFame += stageFameBase + (globalIdx * stageFameGrowth);
                    fameLabels.push(globalIdx);
                    fameValues.push(totalFame);
                    scoutValues.push(totalFame / scoutX1);
                    globalIdx++;
                }
            });
            renderBarChart('fameChart', fameLabels, fameValues, 'Cumulative Fame', '#3b82f6');
            renderBarChart('scoutChart', fameLabels, scoutValues, 'Cumulative Pulls', '#8b5cf6');

            // Save state
            saveConfig();
        }

        // --- SHOP & UTILS ---
        function renderPacksTable() {
            const tbody = document.getElementById('diamond_packs_table');
            tbody.innerHTML = '';
            state.packs.forEach((p, i) => {
                const row = `<tr><td class="p-2">Tier ${i+1}</td><td class="p-2"><input type="number" step="0.01" class="w-16 bg-slate-900 border border-slate-700 rounded" value="${p.price}" onchange="state.packs[${i}].price=parseFloat(this.value);updateShop();saveConfig()"></td><td class="p-2"><input type="number" class="w-16 bg-slate-900 border border-slate-700 rounded" value="${p.amount}" onchange="state.packs[${i}].amount=parseFloat(this.value);updateShop();saveConfig()"></td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function updateShop() {
            const basePack = state.packs[0];
            const val = basePack.price / basePack.amount;
            document.getElementById('diamond_value_base').innerText = `$${val.toFixed(4)}`;
            
            const chests = [
                {name:"Rare", cId:'chest_rare_cost', cardId:'chest_rare_cards'},
                {name:"Epic", cId:'chest_epic_cost', cardId:'chest_epic_cards'},
                {name:"Legend", cId:'chest_legend_cost', cardId:'chest_legend_cards'}
            ];
            const tbody = document.getElementById('shop_analysis_table');
            tbody.innerHTML = '';
            chests.forEach(c => {
                const cost = parseFloat(document.getElementById(c.cId).value);
                const cards = parseFloat(document.getElementById(c.cardId).value);
                const usd = cost * val;
                tbody.innerHTML += `<tr><td class="p-2">${c.name}</td><td class="p-2 text-blue-300">${cost}ðŸ’Ž</td><td class="p-2">$${usd.toFixed(2)}</td><td class="p-2">$${(usd/cards).toFixed(2)}</td><td class="p-2 text-green-400">${(cards/usd).toFixed(2)}</td><td class="p-2 text-slate-500">$${(usd*0.9).toFixed(2)}-$${(usd*1.1).toFixed(2)}</td></tr>`;
            });
        }

        // --- CHARTS RENDERERS ---
        function renderLineChart(id, labels, datasets, log) {
            const el = document.getElementById(id);
            if (!el) return;
            const ctx = el.getContext('2d');
            if(state.charts[id]) state.charts[id].destroy();
            state.charts[id] = new Chart(ctx, {
                type: 'line', data: { labels, datasets: datasets.map(d=>({...d, tension:0.3, pointRadius:0, borderWidth:2, borderColor: d.color, backgroundColor: d.color})) },
                options: { responsive:true, maintainAspectRatio:false, scales:{y:{type:log?'logarithmic':'linear', grid:{color:'#334155'}}, x:{display:false}}, plugins:{legend:{labels:{color:'#94a3b8'}}} }
            });
        }
        function renderBarChart(id, labels, data, label, color) {
            const el = document.getElementById(id);
            if (!el) return;
            const ctx = el.getContext('2d');
            if(state.charts[id]) state.charts[id].destroy();
            state.charts[id] = new Chart(ctx, {
                type: 'bar', data: { labels, datasets:[{label, data, backgroundColor:color}] },
                options: { responsive:true, maintainAspectRatio:false, scales:{y:{grid:{color:'#334155'}}, x:{display:false}}, plugins:{legend:{display:false}} }
            });
        }

        // --- STORAGE & IMPORT/EXPORT ---
        function saveConfig() { localStorage.setItem(STORAGE_KEY, JSON.stringify({chapters:state.chapters, packs:state.packs, trainings:state.trainings, inputs: getInputs() })); }
        function loadConfig() {
            const s = localStorage.getItem(STORAGE_KEY);
            if(s) {
                const c = JSON.parse(s);
                if(c.chapters) state.chapters = c.chapters;
                if(c.packs) state.packs = c.packs;
                if(c.trainings) state.trainings = c.trainings;
                if(c.inputs) setInputs(c.inputs);
            }
        }
        function resetConfig() { if(confirm("Reset?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        
        function getInputs() {
            return {
                cost_expo: document.getElementById('cost_expo').value,
                income_expo: document.getElementById('income_expo').value,
                dur_decay: document.getElementById('dur_decay').value,
                stage_cash_base: document.getElementById('stage_cash_base').value,
                stage_cash_mult: document.getElementById('stage_cash_mult').value,
                stage_fame_base: document.getElementById('stage_fame_base').value,
                stage_fame_growth: document.getElementById('stage_fame_growth').value,
                rare_mult: document.getElementById('rare_mult').value,
                epic_mult: document.getElementById('epic_mult').value,
                chest_rare_cost: document.getElementById('chest_rare_cost').value,
                chest_rare_cards: document.getElementById('chest_rare_cards').value,
                chest_epic_cost: document.getElementById('chest_epic_cost').value,
                chest_epic_cards: document.getElementById('chest_epic_cards').value,
                chest_legend_cost: document.getElementById('chest_legend_cost').value,
                chest_legend_cards: document.getElementById('chest_legend_cards').value,
                scout_x1: document.getElementById('scout_x1').value,
                scout_x10: document.getElementById('scout_x10').value,
                scout_x40: document.getElementById('scout_x40').value
            };
        }
        function setInputs(d) { for(let k in d) { const e = document.getElementById(k); if(e) e.value=d[k]; } }

        function exportYAML() {
            const y = `version: 3.4\ntrainings:\n${JSON.stringify(state.trainings, null, 2)}\nchapters:\n${JSON.stringify(state.chapters, null, 2)}`;
            document.getElementById('yamlOutput').value = y;
            document.getElementById('exportModal').classList.remove('hidden');
            document.getElementById('exportModal').classList.add('flex');
        }
        
        function closeExport() { document.getElementById('exportModal').classList.add('hidden'); document.getElementById('exportModal').classList.remove('flex'); }
        function openImport() { document.getElementById('importModal').classList.remove('hidden'); document.getElementById('importModal').classList.add('flex'); }
        function closeImport() { document.getElementById('importModal').classList.add('hidden'); document.getElementById('importModal').classList.remove('flex'); }
        
        function parseAndImport() {
            try {
                const j = JSON.parse(document.getElementById('yamlInput').value.replace('version: 3.4\ntrainings:\n', '').replace('\nchapters:\n', ', "chapters": '));
            } catch(e) { alert("Import failed."); }
            closeImport();
        }
        
        function copyToClipboard() {
            document.getElementById('yamlOutput').select(); document.execCommand('copy');
        }

        window.onload = init;
    </script>
</body>
</html>
